# SPECTRUM KERNEL MANAGER
# Ramdisk file for profile based kernel management
# Implementation inspired by Franco's fku profiles

on post-fs-data
    # Enable Spectrum support
    setprop spectrum.support 1

on property:sys.boot_completed=1
    # Set default profile on first boot
    exec u:r:init:s0 root root -- /init.spectrum.sh
    # exec u:r:su:s0 root root -- /init.spectrum.sh

    # Add kernel name
    setprop persist.spectrum.kernel "Xiaomi Mi A1"

    # according to Qcom this legacy value improves first launch latencies
    # stock value is 512k
    setprop dalvik.vm.heapminfree 2m

    write /proc/sys/vm/swappiness 100
    write /sys/module/lowmemorykiller/parameters/minfree "18432,23040,27648,32256,36864,46080"

# Balance (default profile)
on property:persist.spectrum.profile=0 && property:init.svc.qcom-post-boot=stopped

    # CPU
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor interactive
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 652800
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq 2016000
    write /sys/devices/system/cpu/cpufreq/interactive/above_hispeed_delay "19000 1401600:39000"
    write /sys/devices/system/cpu/cpufreq/interactive/go_hispeed_load 85
    write /sys/devices/system/cpu/cpufreq/interactive/timer_rate 20000
    write /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq 1401600
    write /sys/devices/system/cpu/cpufreq/interactive/io_is_busy 0
    write /sys/devices/system/cpu/cpufreq/interactive/target_loads "85 1401600:80"
    write /sys/devices/system/cpu/cpufreq/interactive/min_sample_time 39000
    write /sys/devices/system/cpu/cpufreq/interactive/sampling_down_factor 40000

    write /sys/devices/system/cpu/cpu1/online 1
    write /sys/devices/system/cpu/cpu2/online 1
    write /sys/devices/system/cpu/cpu3/online 1
    write /sys/devices/system/cpu/cpu4/online 1
    write /sys/devices/system/cpu/cpu5/online 1
    write /sys/devices/system/cpu/cpu6/online 1
    write /sys/devices/system/cpu/cpu7/online 1

    # GPU
    write /sys/class/kgsl/kgsl-3d0/devfreq/governor msm-adreno-tz
    write /sys/class/devfreq/soc\:qcom,cpubw/governor bw_hwmon
    write /sys/class/kgsl/kgsl-3d0/default_pwrlevel 4
    write /sys/class/kgsl/kgsl-3d0/devfreq/min_freq 133330000
    write /sys/class/kgsl/kgsl-3d0/devfreq/max_freq 650000000
    write /sys/class/kgsl/kgsl-3d0/max_gpuclk 650000000
    write /sys/module/adreno_idler/parameters/adreno_idler_active Y

    # Storage
    write /sys/block/mmcblk0/queue/scheduler cfq
    write /sys/block/mmcblk0/queue/read_ahead_kb 512

    # TCP congestion
    write /proc/sys/net/ipv4/tcp_congestion_control westwood

    # Misc
    chmod 0664 /sys/module/workqueue/parameters/power_efficient
    write /sys/module/workqueue/parameters/power_efficient Y
    write /sys/kernel/sched/arch_power 1
    write /sys/class/leds/lcd-backlight/max_brightness 255
    write /sys/module/cpu_boost/parameters/input_boost_enabled 0

# Performance
on property:persist.spectrum.profile=1 && property:init.svc.qcom-post-boot=stopped

    # CPU
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor interactive
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 1401600
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq 2016000
    write /sys/devices/system/cpu/cpufreq/interactive/go_hispeed_load 99
    write /sys/devices/system/cpu/cpufreq/interactive/above_hispeed_delay 0
    write /sys/devices/system/cpu/cpufreq/interactive/timer_rate 40000
    write /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq 960000
    write /sys/devices/system/cpu/cpufreq/interactive/timer_slack 480000
    write /sys/devices/system/cpu/cpufreq/interactive/target_loads 80 460800:70 600000:99
    write /sys/devices/system/cpu/cpufreq/interactive/min_sample_time 50000
    write /sys/devices/system/cpu/cpufreq/interactive/boost 1
    write /sys/devices/system/cpu/cpufreq/interactive/align_windows 0
    write /sys/devices/system/cpu/cpufreq/interactive/max_freq_hysteresis 0

    write /sys/devices/system/cpu/cpu1/online 1
    write /sys/devices/system/cpu/cpu2/online 1
    write /sys/devices/system/cpu/cpu3/online 1
    write /sys/devices/system/cpu/cpu4/online 1
    write /sys/devices/system/cpu/cpu5/online 1
    write /sys/devices/system/cpu/cpu6/online 1
    write /sys/devices/system/cpu/cpu7/online 1

    # GPU
    write /sys/class/kgsl/kgsl-3d0/devfreq/governor performance
    write /sys/class/devfreq/soc\:qcom,cpubw/governor performance
    write /sys/class/kgsl/kgsl-3d0/default_pwrlevel 3
    write /sys/class/kgsl/kgsl-3d0/devfreq/min_freq 133330000
    write /sys/class/kgsl/kgsl-3d0/devfreq/max_freq 650000000
    write /sys/class/kgsl/kgsl-3d0/max_gpuclk 650000000
    write /sys/module/adreno_idler/parameters/adreno_idler_active N

    # Storage
    write /sys/block/mmcblk0/queue/scheduler bfq
    write /sys/block/mmcblk0/queue/read_ahead_kb 512

    # TCP congestion
    write /proc/sys/net/ipv4/tcp_congestion_control westwood

    # Misc
    chmod 0664 /sys/module/workqueue/parameters/power_efficient
    write /sys/module/workqueue/parameters/power_efficient N
    write /sys/kernel/sched/arch_power 0
    write /sys/class/leds/lcd-backlight/max_brightness 255
    write /sys/module/cpu_boost/parameters/input_boost_enabled 1
    write /sys/module/cpu_boost/parameters/input_boost_freq "0:1804800"
    write /sys/module/cpu_boost/parameters/input_boost_ms 2000

# Battery
on property:persist.spectrum.profile=2 && property:init.svc.qcom-post-boot=stopped

    # CPU
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor "electron"
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 652800
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq 1958400
    write /sys/devices/system/cpu/cpufreq/electron/above_hispeed_delay 20000
    write /sys/devices/system/cpu/cpufreq/electron/align_windows 0
    write /sys/devices/system/cpu/cpufreq/electron/boost 0
    write /sys/devices/system/cpu/cpufreq/electron/boostpulse_duration 80000
    write /sys/devices/system/cpu/cpufreq/electron/go_hispeed_load 99
    write /sys/devices/system/cpu/cpufreq/electron/hispeed_freq 0
    write /sys/devices/system/cpu/cpufreq/electron/io_is_busy 0
    write /sys/devices/system/cpu/cpufreq/electron/max_freq_hysteresis 0
    write /sys/devices/system/cpu/cpufreq/electron/min_sample_time 80000
    write /sys/devices/system/cpu/cpufreq/electron/powersave_bias 0
    write /sys/devices/system/cpu/cpufreq/electron/screen_off_maxfreq 1401600
    write /sys/devices/system/cpu/cpufreq/electron/target_loads 90
    write /sys/devices/system/cpu/cpufreq/electron/timer_rate 50000
    write /sys/devices/system/cpu/cpufreq/electron/timer_slack 80000
    write /sys/devices/system/cpu/cpufreq/electron/use_migration_notif 0
    write /sys/devices/system/cpu/cpufreq/electron/use_sched_load 1

    # GPU
    write /sys/class/kgsl/kgsl-3d0/devfreq/governor msm-adreno-tz
    write /sys/class/devfreq/soc\:qcom,cpubw/governor bw_hwmon
    write /sys/class/kgsl/kgsl-3d0/default_pwrlevel 6
    write /sys/class/kgsl/kgsl-3d0/devfreq/min_freq 133330000
    write /sys/class/kgsl/kgsl-3d0/devfreq/max_freq 650000000
    write /sys/class/kgsl/kgsl-3d0/max_gpuclk 650000000
    write /sys/module/adreno_idler/parameters/adreno_idler_active Y

    # Storage
    write /sys/block/mmcblk0/queue/scheduler maple
    write /sys/block/mmcblk0/queue/read_ahead_kb 512

    # TCP congestion
    write /proc/sys/net/ipv4/tcp_congestion_control westwood

    # Misc
    chmod 0664 /sys/module/workqueue/parameters/power_efficient
    write /sys/module/workqueue/parameters/power_efficient Y
    write /sys/kernel/sched/arch_power 1
    write /sys/class/leds/lcd-backlight/max_brightness 255
    write /sys/module/cpu_boost/parameters/input_boost_enabled 0

# Gaming
on property:persist.spectrum.profile=3 && property:init.svc.qcom-post-boot=stopped

    # CPU
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 2016000
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq 2016000

    write /sys/devices/system/cpu/cpu1/online 1
    write /sys/devices/system/cpu/cpu2/online 1
    write /sys/devices/system/cpu/cpu3/online 1
    write /sys/devices/system/cpu/cpu4/online 1
    write /sys/devices/system/cpu/cpu5/online 1
    write /sys/devices/system/cpu/cpu6/online 1
    write /sys/devices/system/cpu/cpu7/online 1

    # GPU
    write /sys/class/kgsl/kgsl-3d0/devfreq/governor performance
    write /sys/class/devfreq/soc\:qcom,cpubw/governor performance
    write /sys/class/kgsl/kgsl-3d0/default_pwrlevel 0
    write /sys/class/kgsl/kgsl-3d0/devfreq/min_freq 650000000
    write /sys/class/kgsl/kgsl-3d0/devfreq/max_freq 650000000
    write /sys/class/kgsl/kgsl-3d0/max_gpuclk 650000000
    write /sys/module/adreno_idler/parameters/adreno_idler_active N

    # Storage
    write /sys/block/mmcblk0/queue/scheduler deadline
    write /sys/block/mmcblk0/queue/read_ahead_kb 512

    # TCP congestion
    write /proc/sys/net/ipv4/tcp_congestion_control highspeed

    # Misc
    chmod 0664 /sys/module/workqueue/parameters/power_efficient
    write /sys/module/workqueue/parameters/power_efficient N
    write /sys/kernel/sched/arch_power 0
    write /sys/class/leds/lcd-backlight/max_brightness 255
    write /sys/module/cpu_boost/parameters/input_boost_enabled 1
    write /sys/module/cpu_boost/parameters/input_boost_freq "0:1804800"
    write /sys/module/cpu_boost/parameters/input_boost_ms 2000
